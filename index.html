<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字冒险游戏</title>
    <style>
        /* --- 基础与全局样式 --- */
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --primary-text: #333;
            --secondary-text: #666;
            --border-color: #e0e0e0;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --danger-color: #dc3545;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        .screen {
            width: 100%;
            max-width: 1000px;
            background: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 30px;
            box-sizing: border-box;
        }

        h1, h2 {
            text-align: center;
            color: var(--primary-text);
        }

        /* --- 表单与按钮样式 --- */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-size: 1rem;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 4px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        .btn:hover {
            background-color: var(--accent-hover);
        }

        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        /* --- 游戏主界面布局 --- */
        #game-screen {
            display: flex;
            gap: 20px;
            height: 85vh; /* 视口高度的85% */
        }

        #game-sidebar {
            flex: 0 0 120px; /* 不伸缩，不收缩，基础宽度120px */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #game-sidebar .btn {
            width: 100%;
        }

        #game-main-content {
            flex-grow: 1; /* 占据剩余所有空间 */
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden; /* 防止子元素溢出 */
        }

        #scene-description, #narrative-log {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            background-color: #fafafa;
            overflow-y: auto; /* 内容过多时可滚动 */
        }

        #scene-description {
            flex-shrink: 0; /* 高度不收缩 */
            max-height: 25%;
        }

        #narrative-log {
            flex-grow: 1; /* 占据剩余主要空间 */
        }
        #narrative-log p {
            margin: 0 0 10px 0;
            line-height: 1.6;
        }
        #narrative-log p:last-child {
            margin-bottom: 0;
        }


        #action-form {
            display: flex;
            gap: 10px;
            flex-shrink: 0; /* 高度不收缩 */
        }

        #action-input {
            flex-grow: 1;
        }

        #action-confirm {
            flex-shrink: 0;
            width: auto;
        }
        
        /* --- 加载与模态弹窗 --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        /* 加载动画 */
        .loader-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--accent-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 模态弹窗 */
        #modal-content {
            background: var(--container-bg);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        #modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            border: none;
            background: none;
        }
        #modal-close:hover {
            color: #000;
        }
        #modal-body ul {
            list-style: none;
            padding: 0;
        }
        #modal-body li {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        #modal-body li:last-child {
            border-bottom: none;
        }
        #modal-body strong {
            color: var(--accent-color);
        }

        /* --- 响应式设计 (移动端) --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .screen {
                padding: 20px;
            }
            #game-screen {
                flex-direction: column;
                height: 90vh;
            }
            #game-sidebar {
                flex-direction: row;
                flex: 0 0 auto; /* 恢复自动高度 */
                justify-content: space-around;
            }
            #game-sidebar .btn {
                padding: 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <!-- ======== 开始界面 (Start Screen) ======== -->
    <div id="start-screen" class="screen">
        <h1>文字冒险</h1>
        <form id="continue-game-form">
            <div class="form-group">
                <label for="world-id-input">输入世界ID继续游戏</label>
                <input type="text" id="world-id-input" class="form-control" placeholder="粘贴您的 world_id" required>
            </div>
            <button type="submit" class="btn">进入世界</button>
        </form>
        <div class="btn-container">
            <hr>
            <button id="go-to-create-btn" class="btn btn-secondary">或者，创建一个新世界</button>
        </div>
    </div>

    <!-- ======== 创建世界界面 (Create World Screen) ======== -->
    <div id="create-world-screen" class="screen hidden">
        <h2>创建新世界</h2>
        <form id="create-world-form">
            <div class="form-group">
                <label for="protagonist-name">主角姓名</label>
                <input type="text" id="protagonist-name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="protagonist-gender">性别</label>
                <input type="text" id="protagonist-gender" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="protagonist-age">年龄</label>
                <input type="number" id="protagonist-age" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="user-preference">用一句话描述你想要的世界</label>
                <textarea id="user-preference" class="form-control" placeholder="例如：一个被巨龙阴影笼罩的、摇摇欲坠的王国" required></textarea>
            </div>
            <div class="btn-container">
                <button type="submit" class="btn">开始创世</button>
                <button type="button" id="back-to-start-btn" class="btn btn-secondary">返回</button>
            </div>
        </form>
    </div>

    <!-- ======== 游戏主界面 (Game Screen) ======== -->
    <div id="game-screen" class="screen hidden">
        <!-- 左侧功能按钮 (Sidebar) -->
        <aside id="game-sidebar">
            <button id="map-btn" class="btn">地图</button>
            <button id="items-btn" class="btn">物品</button>
            <button id="logs-btn" class="btn">日志</button>
        </aside>
        
        <!-- 右侧主内容区 (Main Content) -->
        <main id="game-main-content">
            <div id="scene-description">
                <!-- 场景描述将在这里动态加载 -->
            </div>
            <div id="narrative-log">
                <!-- 叙事后果将在这里动态追加 -->
            </div>
            <form id="action-form">
                <input type="text" id="action-input" class="form-control" placeholder="接下来你打算做什么？" autocomplete="off">
                <button type="submit" id="action-confirm" class="btn">确认</button>
            </form>
        </main>
    </div>

    <!-- ======== 加载动画覆盖层 (Loader Overlay) ======== -->
    <div id="loader" class="overlay hidden">
        <div class="loader-spinner"></div>
    </div>

    <!-- ======== 模态弹窗 (Modal) ======== -->
    <div id="modal" class="overlay hidden">
        <div id="modal-content">
            <button id="modal-close">&times;</button>
            <h2 id="modal-title"></h2>
            <div id="modal-body"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 全局变量和配置 (Global Variables & Configuration) ---
    // !!! 重要: 请将下面的URL替换为您自己的n8n Webhook URL
    // !!! IMPORTANT: Replace the URLs below with your own n8n Webhook URLs
    const CREATE_WORLD_URL = 'http://117.72.73.115:5678/webhook/02ceea20-062f-4722-95b3-c8ded6f9d7c4';
    const MAIN_GAME_URL = 'http://117.72.73.115:5678/webhook/83895b94-6f09-4e9d-831d-c01650e01eeb';
    
    let currentWorldId = null;

    // --- DOM元素引用 (DOM Element References) ---
    const screens = {
        start: document.getElementById('start-screen'),
        create: document.getElementById('create-world-screen'),
        game: document.getElementById('game-screen'),
    };
    
    const loader = document.getElementById('loader');
    const modal = {
        element: document.getElementById('modal'),
        title: document.getElementById('modal-title'),
        body: document.getElementById('modal-body'),
        closeBtn: document.getElementById('modal-close'),
    };

    const gameUI = {
        sceneDescription: document.getElementById('scene-description'),
        narrativeLog: document.getElementById('narrative-log'),
        actionInput: document.getElementById('action-input'),
    };

    // --- 核心功能函数 (Core Functions) ---

    /**
     * 显示指定的屏幕，隐藏其他屏幕
     * @param {string} screenName - 'start', 'create', 或 'game'
     */
    function showScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
    }
    
    /**
     * 切换加载动画的显示状态
     * @param {boolean} show - true为显示, false为隐藏
     */
    function toggleLoader(show) {
        loader.classList.toggle('hidden', !show);
    }

    /**
     * 显示模态弹窗
     * @param {string} title - 弹窗标题
     * @param {string} htmlContent - 弹窗主体内容的HTML
     */
    function showModal(title, htmlContent) {
        modal.title.textContent = title;
        modal.body.innerHTML = htmlContent;
        modal.element.classList.remove('hidden');
    }

    /**
     * 隐藏模态弹窗
     */
    function hideModal() {
        modal.element.classList.add('hidden');
    }

    /**
     * 向n8n Webhook发送API请求
     * @param {string} url - Webhook URL
     * @param {object} body - 请求体
     * @returns {Promise<object>} - 返回解析后的JSON响应
     */
    async function apiCall(url, body) {
        toggleLoader(true);
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!response.ok) {
                throw new Error(`网络响应错误: ${response.statusText}`);
            }
            return await response.json();
        } catch (error) {
            console.error('API调用失败:', error);
            alert(`请求失败: ${error.message}`);
            return null; // 返回null以便调用者处理
        } finally {
            toggleLoader(false);
        }
    }
    
    /**
     * 更新游戏主界面的叙事内容
     * @param {string} htmlContent - 要追加到叙事日志的HTML内容
     * @param {boolean} clear - 是否清空现有日志
     */
    function updateNarrative(htmlContent, clear = false) {
        if (clear) {
            gameUI.narrativeLog.innerHTML = '';
        }
        const p = document.createElement('p');
        p.innerHTML = htmlContent;
        gameUI.narrativeLog.appendChild(p);
        // 自动滚动到底部
        gameUI.narrativeLog.scrollTop = gameUI.narrativeLog.scrollHeight;
    }

    /**
     * 初始化游戏界面
     * @param {object} initialData - 包含初始场景和叙事的游戏数据
     */
    function initializeGameUI(initialData) {
        // 根据您的工作流返回的数据结构，这里可能需要调整
        // 假设创世流返回`initial_scene_description`和`opening_narrative`
        // 假设继续游戏流返回`scene_description`和`narrative_consequence`
        const scene = initialData.scene_description || initialData.initial_scene_description || "欢迎来到这个世界。";
        const narrative = initialData.narrative_consequence || initialData.opening_narrative || "你站在这里，思考着第一步。";
        
        gameUI.sceneDescription.innerHTML = scene;
        updateNarrative(narrative, true);
        showScreen('game');
    }

    // --- 事件监听器绑定 (Event Listener Bindings) ---

    // 导航按钮
    document.getElementById('go-to-create-btn').addEventListener('click', () => showScreen('create'));
    document.getElementById('back-to-start-btn').addEventListener('click', () => showScreen('start'));

    // 继续游戏表单
    document.getElementById('continue-game-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const worldId = document.getElementById('world-id-input').value.trim();
        if (!worldId) return;

        currentWorldId = worldId;
        // 使用一个通用的动作（如“环顾四周”）来获取初始状态
        // This action needs to be handled by your n8n workflow to return the initial scene.
        const responseData = await apiCall(MAIN_GAME_URL, { 
            world_id: currentWorldId, 
            player_action: 'look around'
        });
        
        if (responseData && responseData.length > 0) {
            initializeGameUI(responseData[0]); // n8n通常返回一个数组
        }
    });

    // 创建世界表单
    document.getElementById('create-world-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            protagonist: {
                name: document.getElementById('protagonist-name').value,
                gender: document.getElementById('protagonist-gender').value,
                age: document.getElementById('protagonist-age').value,
            },
            user_preference: document.getElementById('user-preference').value,
        };
        
        // 创世工作流应返回新世界的ID和初始数据
        // Your "create world" workflow must return the new world_id.
        const responseData = await apiCall(CREATE_WORLD_URL, payload);
        
        if (responseData && responseData.world_id) {
            currentWorldId = responseData.world_id;
            initializeGameUI(responseData);
        } else {
             alert('创建世界失败，未从服务器获取到有效的世界ID。请检查n8n工作流的最终输出。');
        }
    });

    // 游戏内动作表单
    document.getElementById('action-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const actionText = gameUI.actionInput.value.trim();
        if (!actionText) return;

        // 在日志中回显玩家的输入
        updateNarrative(`<strong>> ${actionText}</strong>`);
        gameUI.actionInput.value = '';

        const responseData = await apiCall(MAIN_GAME_URL, {
            world_id: currentWorldId,
            player_action: actionText,
        });

        if (responseData && responseData.length > 0) {
            const result = responseData[0];
            // 如果有新的场景描述，则更新
            if (result.scene_description) {
                gameUI.sceneDescription.innerHTML = result.scene_description;
            }
            // 更新叙事
            if (result.narrative_consequence) {
                updateNarrative(result.narrative_consequence);
            }
        }
    });

    // 侧边栏功能按钮
    document.getElementById('map-btn').addEventListener('click', async () => {
        const responseData = await apiCall(MAIN_GAME_URL, {
            world_id: currentWorldId,
            player_action: 'action_show_map',
        });
        
        // 检查返回的是否为有效数组
        if (responseData && Array.isArray(responseData) && responseData.length > 0) {
            try {
                const locationData = responseData[0]; // 假设返回数组的第一个元素是当前位置信息
                const locationName = locationData.name;
                
                // exits是JSON字符串，需要解析
                const exitsObject = JSON.parse(locationData.exits);
                
                let exitsHtml = '';
                // 遍历解析后的出口对象，生成列表
                for (const [direction, destination] of Object.entries(exitsObject)) {
                    exitsHtml += `<li>${direction}: ${destination}</li>`;
                }

                // 构建最终的HTML内容
                let html = `
                    <ul>
                        <li><strong>当前位置:</strong> ${locationName}</li>
                    </ul>
                    <strong>出口:</strong>
                    <ul>
                        ${exitsHtml || '<li>此地无路可走。</li>'}
                    </ul>`;
                
                showModal('地图', html);

            } catch (e) {
                console.error("解析地图数据失败:", e);
                showModal('地图', '<p>收到的地图数据格式不正确。</p>');
            }
        } else {
            showModal('地图', '<p>无法获取地图信息或信息为空。</p>');
        }
    });

    document.getElementById('items-btn').addEventListener('click', async () => {
        const responseData = await apiCall(MAIN_GAME_URL, {
            world_id: currentWorldId,
            player_action: 'action_show_items',
        });
        if (responseData && responseData.length > 0 && responseData[0].display_type === 'items_list') {
            const items = responseData[0].content;
            let html = '<ul>';
            if (items.length > 0) {
                items.forEach(item => {
                    html += `<li><strong>${item.name}</strong><br><small>${item.description}</small></li>`;
                });
            } else {
                html += '<li>你的行囊空空如也。</li>';
            }
            html += '</ul>';
            showModal('我的物品', html);
        } else {
            showModal('我的物品', '<p>无法获取物品信息。</p>');
        }
    });
    
    // **[MODIFIED]** 日志按钮功能实现
    document.getElementById('logs-btn').addEventListener('click', async () => {
        const responseData = await apiCall(MAIN_GAME_URL, {
            world_id: currentWorldId,
            player_action: 'action_show_logs'
        });

        // 检查返回的数据结构是否符合预期
        if (responseData && Array.isArray(responseData) && responseData.length > 0 && responseData[0].log && Array.isArray(responseData[0].log)) {
            const logs = responseData[0].log;
            let html = '<ul>';

            if (logs.length > 0) {
                // 遍历日志数组，创建列表项
                logs.forEach(logEntry => {
                    html += `<li><strong>${logEntry.name}</strong><br><small>${logEntry.property_log_decription}</small></li>`;
                });
            } else {
                html += '<li>暂无日志记录。</li>';
            }
            html += '</ul>';
            showModal('游戏日志', html);
        } else {
            // 如果数据格式不符或为空，显示错误提示
            showModal('游戏日志', '<p>无法获取日志信息或格式不正确。</p>');
        }
    });

    // 模态弹窗关闭按钮
    modal.closeBtn.addEventListener('click', hideModal);
    modal.element.addEventListener('click', (e) => {
        // 点击背景关闭
        if (e.target === modal.element) {
            hideModal();
        }
    });

});
</script>

</body>
</html>
