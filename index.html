<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字冒险游戏</title>
    <style>
        /* --- 基础与全局样式 --- */
        :root {
            --bg-color: #f0f2f5;
            --container-bg: #ffffff;
            --primary-text: #333;
            --secondary-text: #666;
            --border-color: #e0e0e0;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --danger-color: #dc3545;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        .screen {
            width: 100%;
            max-width: 1000px;
            background: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 30px;
            box-sizing: border-box;
        }

        h1, h2 {
            text-align: center;
            color: var(--primary-text);
        }

        /* --- 表单与按钮样式 --- */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            font-size: 1rem;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 4px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        .btn:hover {
            background-color: var(--accent-hover);
        }

        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        /* --- 游戏主界面布局 --- */
        #game-screen {
            display: flex;
            gap: 20px;
            height: 85vh; /* 视口高度的85% */
        }

        #game-sidebar {
            flex: 0 0 120px; /* 不伸缩，不收缩，基础宽度120px */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #game-sidebar .btn {
            width: 100%;
        }

        #game-main-content {
            flex-grow: 1; /* 占据剩余所有空间 */
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden; /* 防止子元素溢出 */
        }

        #scene-description, #narrative-log {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            background-color: #fafafa;
            overflow-y: auto; /* 内容过多时可滚动 */
            white-space: pre-wrap; /* 保持换行 */
            word-wrap: break-word;
        }

        #scene-description {
            flex-shrink: 0; /* 高度不收缩 */
            max-height: 25%;
        }

        #narrative-log {
            flex-grow: 1; /* 占据剩余主要空间 */
        }
        #narrative-log p {
            margin: 0 0 10px 0;
            line-height: 1.6;
        }
        #narrative-log p:last-child {
            margin-bottom: 0;
        }


        #action-form {
            display: flex;
            gap: 10px;
            flex-shrink: 0; /* 高度不收缩 */
        }

        #action-input {
            flex-grow: 1;
        }

        #action-confirm {
            flex-shrink: 0;
            width: auto;
        }
        
        /* --- 加载与模态弹窗 --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        /* 加载动画 */
        .loader-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--accent-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 模态弹窗 */
        #modal-content {
            background: var(--container-bg);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        #modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            border: none;
            background: none;
        }
        #modal-close:hover {
            color: #000;
        }
        #modal-body ul {
            list-style: none;
            padding: 0;
        }
        #modal-body li {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        #modal-body li:last-child {
            border-bottom: none;
        }
        #modal-body strong {
            color: var(--accent-color);
        }

        /* --- 响应式设计 (移动端) --- */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .screen {
                padding: 20px;
            }
            #game-screen {
                flex-direction: column;
                height: 90vh;
            }
            #game-sidebar {
                flex-direction: row;
                flex: 0 0 auto; /* 恢复自动高度 */
                justify-content: space-around;
            }
            #game-sidebar .btn {
                padding: 10px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>

    <!-- ======== 开始界面 (Start Screen) ======== -->
    <div id="start-screen" class="screen">
        <h1>文字冒险</h1>
        <form id="continue-game-form">
            <div class="form-group">
                <label for="world-id-input">输入世界ID继续游戏</label>
                <input type="text" id="world-id-input" class="form-control" placeholder="粘贴您的 world_id" required>
            </div>
            <button type="submit" class="btn">进入世界</button>
        </form>
        <div class="btn-container">
            <hr>
            <button id="go-to-create-btn" class="btn btn-secondary">或者，创建一个新世界</button>
        </div>
    </div>

    <!-- ======== 创建世界界面 (Create World Screen) ======== -->
    <div id="create-world-screen" class="screen hidden">
        <h2>创建新世界</h2>
        <form id="create-world-form">
            <div class="form-group">
                <label for="protagonist-name">主角姓名</label>
                <input type="text" id="protagonist-name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="protagonist-gender">性别</label>
                <input type="text" id="protagonist-gender" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="protagonist-age">年龄</label>
                <input type="number" id="protagonist-age" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="user-preference">用一句话描述你想要的世界</label>
                <textarea id="user-preference" class="form-control" placeholder="例如：一个被巨龙阴影笼罩的、摇摇欲坠的王国" required></textarea>
            </div>
            <div class="btn-container">
                <button type="submit" class="btn">开始创世</button>
                <button type="button" id="back-to-start-btn" class="btn btn-secondary">返回</button>
            </div>
        </form>
    </div>

    <!-- ======== 游戏主界面 (Game Screen) ======== -->
    <div id="game-screen" class="screen hidden">
        <!-- 左侧功能按钮 (Sidebar) -->
        <aside id="game-sidebar">
            <button id="map-btn" class="btn">地图</button>
            <button id="items-btn" class="btn">物品</button>
            <button id="logs-btn" class="btn">日志</button>
        </aside>
        
        <!-- 右侧主内容区 (Main Content) -->
        <main id="game-main-content">
            <div id="scene-description">
                <!-- 场景描述将在这里动态加载 -->
            </div>
            <div id="narrative-log">
                <!-- 叙事后果将在这里动态追加 -->
            </div>
            <form id="action-form">
                <input type="text" id="action-input" class="form-control" placeholder="接下来你打算做什么？" autocomplete="off">
                <button type="submit" id="action-confirm" class="btn">确认</button>
            </form>
        </main>
    </div>

    <!-- ======== 加载动画覆盖层 (Loader Overlay) ======== -->
    <div id="loader" class="overlay hidden">
        <div class="loader-spinner"></div>
    </div>

    <!-- ======== 模态弹窗 (Modal) ======== -->
    <div id="modal" class="overlay hidden">
        <div id="modal-content">
            <button id="modal-close">&times;</button>
            <h2 id="modal-title"></h2>
            <div id="modal-body"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 全局变量和配置 (Global Variables & Configuration) ---
    const CREATE_WORLD_URL = 'https://n8n.frankyany.dpdns.org/webhook/416b9faa-af93-40c7-a6ea-42202d4773c3';
    const MAIN_GAME_URL = 'https://n8n.frankyany.dpdns.org/webhook/83895b94-6f09-4e9d-831d-c01650e01eeb';
    
    let currentWorldId = null;

    // --- DOM元素引用 (DOM Element References) ---
    const screens = {
        start: document.getElementById('start-screen'),
        create: document.getElementById('create-world-screen'),
        game: document.getElementById('game-screen'),
    };
    
    const loader = document.getElementById('loader');
    const modal = {
        element: document.getElementById('modal'),
        title: document.getElementById('modal-title'),
        body: document.getElementById('modal-body'),
        closeBtn: document.getElementById('modal-close'),
    };

    const gameUI = {
        sceneDescription: document.getElementById('scene-description'),
        narrativeLog: document.getElementById('narrative-log'),
        actionInput: document.getElementById('action-input'),
    };

    // --- 核心功能函数 (Core Functions) ---

    function escapeHTML(str) {
        if (typeof str !== 'string') {
            return '';
        }
        return str.replace(/[&<>'"]/g, 
            tag => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[tag] || tag)
        );
    }

    function showScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        screens[screenName].classList.remove('hidden');
    }
    
    function toggleLoader(show) {
        loader.classList.toggle('hidden', !show);
    }

    function showModal(title, htmlContent) {
        modal.title.textContent = title;
        modal.body.innerHTML = htmlContent;
        modal.element.classList.remove('hidden');
    }

    function hideModal() {
        modal.element.classList.add('hidden');
    }

    async function apiCall(url, body) {
        toggleLoader(true);
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!response.ok) {
                throw new Error(`网络响应错误: ${response.statusText} (${response.status})`);
            }
            return await response.json();
        } catch (error) {
            console.error('API调用失败:', error);
            showModal('请求失败', `<p>${escapeHTML(error.message)}</p>`);
            return null;
        } finally {
            toggleLoader(false);
        }
    }
    
    function updateNarrative(content, clear = false, isSafeHTML = false) {
        if (clear) {
            gameUI.narrativeLog.innerHTML = '';
        }
        const p = document.createElement('p');
        if (isSafeHTML) {
            p.innerHTML = content;
        } else {
            p.textContent = content;
        }
        gameUI.narrativeLog.appendChild(p);
        gameUI.narrativeLog.scrollTop = gameUI.narrativeLog.scrollHeight;
    }

    function initializeGameUI(initialData) {
        const scene = initialData.scene_description || initialData.initial_scene_description || "欢迎来到这个世界。";
        const narrative = initialData.narrative_consequence || initialData.opening_narrative || "你站在这里，思考着第一步。";
        
        gameUI.sceneDescription.textContent = scene;
        updateNarrative(narrative, true, false);
        showScreen('game');
    }

    // --- 事件监听器绑定 (Event Listener Bindings) ---

    document.getElementById('go-to-create-btn').addEventListener('click', () => showScreen('create'));
    document.getElementById('back-to-start-btn').addEventListener('click', () => showScreen('start'));

    document.getElementById('continue-game-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const worldId = document.getElementById('world-id-input').value.trim();
        if (!worldId) return;

        currentWorldId = worldId;
        const responseData = await apiCall(MAIN_GAME_URL, { 
            world_id: currentWorldId, 
            player_action: 'action_show_past'
        });
        
        let gameData = null;
        if (responseData) {
            if (Array.isArray(responseData) && responseData.length > 0) {
                gameData = responseData[0];
            } else if (typeof responseData === 'object' && !Array.isArray(responseData) && responseData.scene_description) {
                gameData = responseData;
            }
        }

        if (gameData) {
            initializeGameUI(gameData);
        } else {
            showModal('加载失败', '<p>从服务器收到的数据格式不正确或为空，无法加载游戏。请检查n8n工作流的执行日志。</p>');
        }
    });

    document.getElementById('create-world-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            protagonist: {
                name: document.getElementById('protagonist-name').value,
                gender: document.getElementById('protagonist-gender').value,
                age: document.getElementById('protagonist-age').value,
            },
            user_preference: document.getElementById('user-preference').value,
        };
        
        const responseData = await apiCall(CREATE_WORLD_URL, payload);
        
        if (responseData && Array.isArray(responseData) && responseData.length > 0 && responseData[0].world_id) {
            const result = responseData[0];
            currentWorldId = result.world_id;
            initializeGameUI(result);
        } else {
             showModal('创建失败', '<p>未从服务器获取到有效的世界ID或返回格式不正确。请检查n8n工作流的最终输出。</p>');
        }
    });

    document.getElementById('action-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const actionText = gameUI.actionInput.value.trim();
        if (!actionText) return;

        updateNarrative(`<strong>> ${escapeHTML(actionText)}</strong>`, false, true);
        gameUI.actionInput.value = '';

        const responseData = await apiCall(MAIN_GAME_URL, {
            world_id: currentWorldId,
            player_action: actionText,
        });

        if (responseData && responseData.length > 0) {
            const result = responseData[0];
            
            // [NEW] 增加对行动有效性的判断
            if (result.is_action_valid === false) {
                // 如果行动无效，显示弹窗，并更新叙事日志以提供上下文
                showModal('行动失败', '<p>行动违反当前世界法则，不予执行。</p>');
                if (result.outcome_summary) {
                    updateNarrative(result.outcome_summary, false, false);
                }
            } else {
                // 如果行动有效，则执行正常的界面更新
                if (result.scene_description) {
                    gameUI.sceneDescription.textContent = result.scene_description;
                }
                if (result.narrative_consequence) {
                    updateNarrative(result.narrative_consequence, false, false);
                }
            }
        }
    });

    // 侧边栏功能按钮
    document.getElementById('map-btn').addEventListener('click', async () => {
        const responseData = await apiCall(MAIN_GAME_URL, {
            world_id: currentWorldId,
            player_action: 'action_show_map',
        });
        
        if (responseData && Array.isArray(responseData) && responseData.length > 0) {
            try {
                const locationData = responseData[0];
                const locationName = locationData.name;
                const exitsObject = locationData.exits; 
                
                let exitsHtml = '';
                if (exitsObject && typeof exitsObject === 'object') {
                    for (const [direction, destination] of Object.entries(exitsObject)) {
                        exitsHtml += `<li>${escapeHTML(direction)}: ${escapeHTML(String(destination))}</li>`;
                    }
                }

                let html = `
                    <ul>
                        <li><strong>当前位置:</strong> ${escapeHTML(locationName)}</li>
                    </ul>
                    <strong>出口:</strong>
                    <ul>
                        ${exitsHtml || '<li>此地无路可走。</li>'}
                    </ul>`;
                
                showModal('地图', html);

            } catch (e) {
                console.error("解析地图数据失败:", e);
                showModal('地图', '<p>收到的地图数据格式不正确。</p>');
            }
        } else {
            showModal('地图', '<p>无法获取地图信息或信息为空。</p>');
        }
    });

    document.getElementById('items-btn').addEventListener('click', async () => {
        const responseData = await apiCall(MAIN_GAME_URL, {
            world_id: currentWorldId,
            player_action: 'action_show_items',
        });
        if (responseData && responseData.length > 0 && responseData[0].display_type === 'items_list') {
            const items = responseData[0].content;
            let html = '<ul>';
            if (items.length > 0) {
                items.forEach(item => {
                    html += `<li><strong>${escapeHTML(item.name)}</strong><br><small>${escapeHTML(item.description)}</small></li>`;
                });
            } else {
                html += '<li>你的行囊空空如也。</li>';
            }
            html += '</ul>';
            showModal('我的物品', html);
        } else {
            showModal('我的物品', '<p>无法获取物品信息。</p>');
        }
    });
    
    document.getElementById('logs-btn').addEventListener('click', async () => {
        const responseData = await apiCall(MAIN_GAME_URL, {
            world_id: currentWorldId,
            player_action: 'action_show_logs'
        });

        if (responseData && Array.isArray(responseData) && responseData.length > 0 && responseData[0].log && Array.isArray(responseData[0].log)) {
            const logs = responseData[0].log;
            let html = '<ul>';

            if (logs.length > 0) {
                logs.forEach(logEntry => {
                    html += `<li><strong>${escapeHTML(logEntry.log_time)}</strong><br><small>${escapeHTML(logEntry.log_description)}</small></li>`;
                });
            } else {
                html += '<li>暂无日志记录。</li>';
            }
            html += '</ul>';
            showModal('游戏日志', html);
        } else {
            showModal('游戏日志', '<p>无法获取日志信息或格式不正确。</p>');
        }
    });

    // 模态弹窗关闭按钮
    modal.closeBtn.addEventListener('click', hideModal);
    modal.element.addEventListener('click', (e) => {
        if (e.target === modal.element) {
            hideModal();
        }
    });

});
</script>

</body>
</html>
